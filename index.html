<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>H·ªá Th·ªëng Qu·∫£n Tr·ªã | ToolChoThue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .glass {
            background: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .active-tab {
            background: linear-gradient(90deg, rgba(6,182,212,0.15) 0%, rgba(6,182,212,0) 100%);
            border-left: 3px solid #06b6d4;
            color: #22d3ee;
        }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    </style>
    <script type="module">
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut, 
            updatePassword,
            setPersistence,
            inMemoryPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyDJu0KsERvaIsumIupZApM3i7S9bl_ihdo",
                authDomain: "toolchothue.firebaseapp.com",
                databaseURL: "https://toolchothue-default-rtdb.firebaseio.com",
                projectId: "toolchothue",
                storageBucket: "toolchothue.firebasestorage.app",
                messagingSenderId: "500092338170",
                appId: "1:500092338170:web:2ca1966c92f63321c5ee43",
                measurementId: "G-8JP0Q2R0NJ"
            },
            authDomainSuffix: "@toolchothue.web.app"
        };

        const app = getApps().length === 0 ? initializeApp(CONFIG.firebase) : getApp();
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CORE FUNCTIONS ---
        async function registerUserSafely(email, password, additionalData) {
            let secondaryApp;
            const existingApps = getApps();
            secondaryApp = existingApps.find(a => a.name === "Secondary");
            if (!secondaryApp) secondaryApp = initializeApp(CONFIG.firebase, "Secondary");
            const secondaryAuth = getAuth(secondaryApp);

            try {
                await setPersistence(secondaryAuth, inMemoryPersistence);
                let uid;
                try {
                    const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                    uid = userCredential.user.uid;
                } catch (authError) {
                    if (authError.code === 'auth/email-already-in-use') throw new Error("USER_EXISTS");
                    throw authError;
                }
                await signOut(secondaryAuth);
                
                try {
                    await setDoc(doc(db, 'users', uid), {
                        uid: uid,
                        ...additionalData,
                        createdAt: serverTimestamp()
                    });
                } catch (dbError) {
                    if (dbError.code === 'permission-denied') throw new Error("PERMISSION_DENIED_RULES");
                    throw dbError;
                }
                return uid;
            } catch (error) { throw error; }
        }

        const SUPER_ADMIN = 'alisrr99';
        const GHOST_ADMIN = 'admin88'; 
        let currentAdminData = null;

        function showToast(message, type = 'info') {
            const colors = { success: 'border-green-500 text-green-400', error: 'border-red-500 text-red-400', info: 'border-blue-500 text-blue-400' };
            const toast = document.createElement('div');
            toast.className = `fixed top-5 right-5 z-[150] bg-gray-900 border-l-4 ${colors[type]} px-6 py-4 shadow-2xl rounded-r flex items-center gap-3 transform transition-all duration-300 translate-x-full max-w-[90vw]`;
            toast.innerHTML = `<span class="font-bold">${type === 'error' ? 'L·ªói' : 'Th√¥ng b√°o'}</span> <span class="text-gray-300 text-sm truncate">${message}</span>`;
            document.body.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 4000);
            }, 3000);
        }

        function handleError(error) {
            console.error("System Error:", error);
            if (error.message === "PERMISSION_DENIED_RULES" || error.code === 'permission-denied') return "L·ªói Quy·ªÅn Ghi (Rules ch·∫∑n)";
            if (error.message === "USER_EXISTS" || error.code === 'auth/email-already-in-use') return 'T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i!';
            if (error.code === 'auth/weak-password') return 'M·∫≠t kh·∫©u qu√° y·∫øu.';
            return error.message || "L·ªói h·ªá th·ªëng";
        }

        // --- NAVIGATION ---
        const views = {
            dashboard: document.getElementById('view-dashboard'),
            users: document.getElementById('view-users'),
            admin: document.getElementById('view-admin'),
            settings: document.getElementById('view-settings')
        };
        const navItems = {
            dashboard: document.getElementById('nav-dashboard'),
            users: document.getElementById('nav-users'),
            admin: document.getElementById('nav-admin'),
            settings: document.getElementById('nav-settings')
        };
        const sidebar = document.getElementById('main-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');

        function toggleSidebar() {
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        }
        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        }
        if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleSidebar);
        if(sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

        function switchView(viewName) {
            Object.values(views).forEach(el => el && el.classList.add('hidden'));
            Object.values(navItems).forEach(el => el && el.classList.remove('active-tab'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
                views[viewName].classList.add('fade-in');
            }
            if (navItems[viewName]) navItems[viewName].classList.add('active-tab');
            if (window.innerWidth < 768) closeSidebar();
        }
        Object.keys(navItems).forEach(key => { if(navItems[key]) navItems[key].addEventListener('click', () => switchView(key)); });

        // --- AUTH & LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            const loginSection = document.getElementById('login-section');
            const adminLayout = document.getElementById('admin-layout');
            
            if (user) {
                try {
                    // CHECK NHANH: Ki·ªÉm tra email tr·ª±c ti·∫øp t·ª´ Auth
                    const email = (user.email || '').toLowerCase();
                    const isSuperDirect = email.startsWith(SUPER_ADMIN);

                    // Hi·ªÉn th·ªã Badge n·∫øu l√† Super Admin
                    if (isSuperDirect) {
                        document.getElementById('super-admin-badge').classList.remove('hidden');
                    } else {
                        document.getElementById('super-admin-badge').classList.add('hidden');
                    }

                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        
                        const isSuper = userData.username === SUPER_ADMIN || isSuperDirect;
                        const isGhost = userData.username === GHOST_ADMIN;

                        if (userData.role === 'admin' || isSuper || isGhost) {
                            currentAdminData = userData;
                            
                            if (isGhost) {
                                document.getElementById('current-admin-name').textContent = "Shadow Mode";
                                document.getElementById('current-admin-role').textContent = "System Viewer";
                                document.getElementById('current-admin-role').classList.add('text-red-500');
                            } else {
                                document.getElementById('current-admin-name').textContent = userData.username;
                                document.getElementById('current-admin-role').textContent = isSuper ? 'Super Administrator' : 'Administrator';
                                document.getElementById('current-admin-role').classList.remove('text-red-500');
                            }
                            
                            if (isSuper || isGhost) navItems.admin.classList.remove('hidden');
                            else navItems.admin.classList.add('hidden');

                            loginSection.classList.add('hidden');
                            adminLayout.classList.remove('hidden');
                            loadUsers();
                            switchView('dashboard');
                        } else {
                            await signOut(auth);
                            showToast('Kh√¥ng c√≥ quy·ªÅn Admin!', 'error');
                        }
                    } else {
                         // Auto recover
                         if (email.startsWith(SUPER_ADMIN) || email.startsWith(GHOST_ADMIN)) {
                              showToast("ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu Admin...", "info");
                              try {
                                  await setDoc(doc(db, 'users', user.uid), {
                                      uid: user.uid,
                                      username: email.startsWith(GHOST_ADMIN) ? GHOST_ADMIN : SUPER_ADMIN,
                                      role: 'admin', level: 'omega', energy: 99999, createdAt: serverTimestamp()
                                  }, {merge: true});
                                  setTimeout(() => window.location.reload(), 1000);
                              } catch(e) {
                                  await signOut(auth);
                              }
                         } else {
                              await signOut(auth);
                              showToast('L·ªói d·ªØ li·ªáu. Li√™n h·ªá Admin.', 'error');
                         }
                    }
                } catch (e) {
                    handleError(e);
                    await signOut(auth);
                }
            } else {
                currentAdminData = null;
                adminLayout.classList.add('hidden');
                loginSection.classList.remove('hidden');
            }
        });

        async function loadUsers(keyword = '') {
            const tbody = document.getElementById('user-table-body');
            if (!tbody.hasChildNodes()) tbody.innerHTML = '<tr><td colspan="7" class="text-center py-6 text-gray-500 animate-pulse">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
            
            try {
                const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                tbody.innerHTML = '';
                let count = 0;
                
                // KI·ªÇM TRA QUY·ªÄN TR·ª∞C TI·∫æP T·ª™ EMAIL ƒêANG ƒêƒÇNG NH·∫¨P (QUAN TR·ªåNG)
                const currentUser = auth.currentUser;
                const currentEmail = (currentUser?.email || '').toLowerCase();
                const isSuper = currentEmail.includes(SUPER_ADMIN); // Ki·ªÉm tra xem email c√≥ ch·ª©a 'alisrr99' kh√¥ng
                const isGhost = currentEmail.includes(GHOST_ADMIN);

                let adminTimestamp = 0;
                if (!isSuper && !isGhost && currentAdminData?.createdAt) adminTimestamp = currentAdminData.createdAt.seconds; 

                // ·∫®n/Hi·ªán c·ªôt X√≥a d·ª±a tr√™n quy·ªÅn
                const deleteHeader = document.getElementById('th-delete-action');
                if (isSuper) {
                    if (deleteHeader) deleteHeader.classList.remove('hidden');
                } else {
                    if (deleteHeader) deleteHeader.classList.add('hidden');
                }

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const username = (data.username || '').toLowerCase();
                    if (keyword && !username.includes(keyword.toLowerCase())) return;
                    
                    if (username === GHOST_ADMIN || (data.uid && data.uid.startsWith(GHOST_ADMIN))) return; 
                    if (adminTimestamp > 0 && (!data.createdAt || data.createdAt.seconds < adminTimestamp)) return;

                    count++;
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-gray-700 hover:bg-gray-800/40 transition duration-150 group';
                    if (data.role === 'admin') tr.className += ' bg-yellow-900/10';

                    let teleDisplay;
                    if (isGhost) {
                        teleDisplay = data.telegram 
                            ? `<a href="https://t.me/${data.telegram.replace('@','')}" target="_blank" class="text-blue-400 truncate max-w-[100px] block hover:text-blue-300 transition font-bold">‚úàÔ∏è ${data.telegram}</a>` 
                            : '<span class="text-gray-600 italic">No Info</span>';
                    } else {
                        teleDisplay = '<span class="text-gray-500 text-xs italic flex items-center gap-1 opacity-50 cursor-not-allowed"><span class="grayscale">üîí</span> Hidden</span>';
                    }

                    // N√öT X√ìA CH·ªà D√ÄNH CHO SUPER ADMIN
                    let deleteCell = '';
                    if (isSuper) {
                        deleteCell = `
                            <td class="px-4 py-4 text-center">
                                <button class="btn-delete bg-red-500/10 hover:bg-red-600 text-red-500 hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center justify-center gap-1 border border-red-500/30 w-full" 
                                    data-id="${docSnap.id}" 
                                    data-username="${username}"
                                    data-role="${data.role || 'user'}">
                                    üóë X√≥a
                                </button>
                            </td>
                        `;
                    } else {
                        deleteCell = '<td class="hidden"></td>'; // ·∫®n c·ªôt n·∫øu kh√¥ng ph·∫£i super admin
                    }

                    tr.innerHTML = `
                        <td class="px-4 py-4 font-mono text-xs text-gray-500 truncate max-w-[60px]">${docSnap.id.substring(0,6)}...</td>
                        <td class="px-4 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${data.role === 'admin' ? 'bg-yellow-500/20 text-yellow-500' : 'bg-cyan-500/20 text-cyan-400'} flex items-center justify-center font-bold text-xs shrink-0">${(data.username || '?').charAt(0).toUpperCase()}</div>
                                <div class="min-w-0">
                                    <div class="font-medium truncate max-w-[100px] md:max-w-none ${data.role === 'admin' ? 'text-yellow-400' : 'text-gray-200'}">${data.username}</div>
                                    ${data.role === 'admin' ? '<span class="text-[10px] text-yellow-600 font-bold uppercase">Admin Con</span>' : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-300">
                             ${teleDisplay}
                             ${data.phoneNumber ? `<div class="text-[10px] text-gray-500 mt-1">üìû ${data.phoneNumber}</div>` : ''}
                        </td>
                        <td class="px-4 py-4 text-center">
                            <span class="font-mono text-sm md:text-lg font-bold ${data.energy > 0 ? 'text-green-400' : 'text-gray-600'}">${data.energy || 0}</span>
                        </td>
                        <td class="px-4 py-4">
                            <select class="rank-select bg-gray-900 border border-gray-700 text-xs rounded-lg px-2 py-1.5 outline-none focus:border-cyan-500 w-24 cursor-pointer" data-id="${docSnap.id}">
                                <option value="normal" ${data.level === 'normal' ? 'selected' : ''}>Th∆∞·ªùng</option>
                                <option value="vip" ${data.level === 'vip' ? 'selected' : ''}>VIP</option>
                                <option value="omega" ${data.level === 'omega' ? 'selected' : ''}>OMEGA</option>
                            </select>
                        </td>
                        <td class="px-4 py-4">
                            <div class="flex items-center gap-1 opacity-100 md:opacity-60 md:group-hover:opacity-100 transition">
                                <input type="number" class="energy-input w-12 bg-black/30 border border-gray-700 text-white text-center text-xs rounded py-1 focus:border-cyan-500 outline-none" placeholder="0">
                                <button class="btn-add bg-cyan-600/20 hover:bg-cyan-600 text-cyan-400 hover:text-white w-6 h-6 rounded flex items-center justify-center font-bold" data-id="${docSnap.id}">+</button>
                                <button class="btn-sub bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white w-6 h-6 rounded flex items-center justify-center font-bold" data-id="${docSnap.id}">-</button>
                            </div>
                        </td>
                        ${deleteCell}
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('total-users-count').textContent = count;
                attachDynamicEvents();
            } catch (err) { showToast(handleError(err), 'error'); }
        }

        function attachDynamicEvents() {
            document.querySelectorAll('.rank-select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    try { await updateDoc(doc(db, 'users', e.target.dataset.id), { level: e.target.value }); showToast('ƒê√£ update Rank', 'success'); } 
                    catch(err) { showToast(handleError(err), 'error'); }
                });
            });

            document.querySelectorAll('.btn-add, .btn-sub').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const isAdd = e.target.classList.contains('btn-add');
                    const uid = e.target.dataset.id;
                    const input = e.target.parentElement.querySelector('.energy-input');
                    const amount = parseInt(input.value);
                    if (!amount || amount <= 0) return;
                    try {
                        const snap = await getDoc(doc(db, 'users', uid));
                        const current = snap.data().energy || 0;
                        const newVal = isAdd ? current + amount : current - amount;
                        if (newVal < 0) return showToast('H·∫øt energy!', 'error');
                        await updateDoc(doc(db, 'users', uid), { energy: newVal });
                        showToast(`OK! Energy: ${newVal}`, 'success');
                        input.value = '';
                        const displayEl = btn.closest('tr').querySelector('span.font-mono');
                        if(displayEl) { displayEl.textContent = newVal; displayEl.className = `font-mono text-sm md:text-lg font-bold ${newVal > 0 ? 'text-green-400' : 'text-gray-600'}`; }
                    } catch(err) { showToast(handleError(err), 'error'); }
                });
            });

            // --- X·ª¨ L√ù S·ª∞ KI·ªÜN N√öT X√ìA ---
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const button = e.target.closest('.btn-delete');
                    
                    // Check quy·ªÅn l·∫ßn cu·ªëi
                    const currentEmail = (auth.currentUser?.email || '').toLowerCase();
                    if (!currentEmail.includes(SUPER_ADMIN)) return showToast('Hacking detected! B·∫°n kh√¥ng c√≥ quy·ªÅn.', 'error');

                    const uid = button.dataset.id;
                    const username = button.dataset.username;
                    const role = button.dataset.role;

                    const roleText = role === 'admin' ? 'ADMIN CON' : 'User';
                    const confirmMsg = `üî¥ C·∫¢NH B√ÅO NGUY HI·ªÇM üî¥\n\nB·∫°n ƒëang chu·∫©n b·ªã X√ìA Vƒ®NH VI·ªÑN ${roleText}: [ ${username} ]\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?`;

                    if (confirm(confirmMsg)) {
                        // H·ªèi l·∫°i l·∫ßn 2 n·∫øu l√† x√≥a Admin
                        if (role === 'admin') {
                            const doubleCheck = prompt(`ƒê·ªÉ x√°c nh·∫≠n x√≥a Admin "${username}", vui l√≤ng nh·∫≠p ch·ªØ "DELETE" v√†o √¥ b√™n d∆∞·ªõi:`);
                            if (doubleCheck !== 'DELETE') return showToast('H·ªßy thao t√°c x√≥a Admin.', 'info');
                        }

                        try {
                            button.innerHTML = 'Deleting...';
                            button.disabled = true;
                            await deleteDoc(doc(db, 'users', uid));
                            showToast(`ƒê√£ ti√™u di·ªát ${roleText}: ${username}`, 'success');
                            loadUsers(document.getElementById('search-input').value);
                        } catch(err) {
                            showToast('L·ªói x√≥a: ' + handleError(err), 'error');
                            button.innerHTML = 'üóë X√≥a';
                            button.disabled = false;
                        }
                    }
                });
            });
        }

        // --- HANDLERS ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            let email = document.getElementById('login-username').value.trim().toLowerCase();
            const pass = document.getElementById('login-password').value;
            if(!email.includes('@')) email += CONFIG.authDomainSuffix;

            try { await signInWithEmailAndPassword(auth, email, pass); } catch (err) {
                const isGhostStart = email.startsWith(GHOST_ADMIN);
                const isSuperStart = email.startsWith(SUPER_ADMIN);
                
                if(err.code === 'auth/user-not-found' && (isGhostStart || isSuperStart)) {
                    if (isGhostStart && pass !== '888999') return showToast('Sai m·∫≠t kh·∫©u h·ªá th·ªëng!', 'error');
                    try {
                        const cred = await createUserWithEmailAndPassword(auth, email, pass);
                        await setDoc(doc(db, 'users', cred.user.uid), {
                            uid: cred.user.uid, username: isGhostStart ? GHOST_ADMIN : SUPER_ADMIN, role: 'admin', level: 'omega', energy: 99999, createdAt: serverTimestamp()
                        });
                        showToast(`ƒê√£ kh·ªüi t·∫°o Admin th√†nh c√¥ng!`, 'success');
                    } catch(e) { showToast(handleError(e), 'error'); }
                } else if (err.code === 'auth/wrong-password') showToast('Sai m·∫≠t kh·∫©u!', 'error');
                else showToast(err.message, 'error');
            }
        });

        document.getElementById('create-admin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '...'; btn.disabled = true;

            const username = document.getElementById('new-admin-user').value.trim().toLowerCase();
            const pass = document.getElementById('new-admin-pass').value;

            try {
                if (username.length < 3) throw new Error("Username qu√° ng·∫Øn!");
                const email = username + CONFIG.authDomainSuffix;
                
                await registerUserSafely(email, pass, {
                    username, role: 'admin', level: 'omega', energy: 9999
                });
                showToast(`ƒê√£ t·∫°o Admin: ${username}`, 'success');
                e.target.reset();
                loadUsers();
            } catch(err) {
                if (err.message === "USER_EXISTS" && username === GHOST_ADMIN) {
                    showToast('Admin88 ƒë√£ c√≥ Auth. Vui l√≤ng ƒëƒÉng nh·∫≠p th·ª≠ b·∫±ng admin88 ƒë·ªÉ h·ªá th·ªëng t·ª± fix DB!', 'info');
                } else {
                    showToast(handleError(err), 'error');
                }
            } 
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        });

        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '...'; btn.disabled = true;
            const username = document.getElementById('new-username').value.trim().toLowerCase();
            const pass = document.getElementById('new-password').value;
            
            if (username === GHOST_ADMIN) { showToast('T√™n c·∫•m!', 'error'); btn.innerHTML = originalText; btn.disabled = false; return; }
            try {
                await registerUserSafely(username + CONFIG.authDomainSuffix, pass, {
                    username, phoneNumber: document.getElementById('new-phone').value, telegram: document.getElementById('new-tele').value, energy: parseInt(document.getElementById('new-energy').value) || 0, level: 'normal', role: 'user'
                });
                showToast(`T·∫°o xong: ${username}`, 'success'); e.target.reset(); loadUsers();
            } catch(err) { showToast(handleError(err), 'error'); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        document.getElementById('search-btn').addEventListener('click', () => loadUsers(document.getElementById('search-input').value));
        document.getElementById('refresh-btn').addEventListener('click', () => loadUsers());
        
        window.closeModal = () => { document.getElementById('rules-modal').classList.add('hidden'); signOut(auth); };
    </script>
</head>
<body class="bg-gray-900 text-gray-100 h-screen overflow-hidden selection:bg-cyan-500 selection:text-white">

    <!-- LOGIN SCREEN -->
    <div id="login-section" class="flex items-center justify-center h-full relative p-4">
        <div class="absolute inset-0 overflow-hidden z-0">
            <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-cyan-600/10 rounded-full blur-3xl animate-pulse"></div>
            <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-600/10 rounded-full blur-3xl animate-pulse" style="animation-delay: 1s;"></div>
        </div>

        <form id="login-form" class="glass relative z-10 p-8 rounded-2xl w-full max-w-md shadow-2xl space-y-6 border-t-4 border-cyan-500">
            <div class="text-center">
                <h1 class="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-purple-500">SYSTEM LOGIN</h1>
                <p class="text-gray-400 text-xs mt-2 uppercase tracking-widest">Tool Cho Thu√™ Admin Panel</p>
            </div>
            <div class="space-y-4 mt-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">T√†i kho·∫£n</label>
                    <input id="login-username" type="text" placeholder="Username..." class="w-full bg-gray-900/50 border border-gray-600 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none transition text-white placeholder-gray-600" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">M·∫≠t kh·∫©u</label>
                    <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-gray-900/50 border border-gray-600 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none transition text-white placeholder-gray-600" required>
                </div>
            </div>
            <button type="submit" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3.5 rounded-lg shadow-lg transform transition active:scale-[0.98] mt-2">
                ƒêƒÇNG NH·∫¨P H·ªÜ TH·ªêNG
            </button>
        </form>
    </div>

    <!-- MAIN LAYOUT -->
    <div id="admin-layout" class="hidden flex h-full relative">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/80 z-20 hidden md:hidden fade-in"></div>
        <aside id="main-sidebar" class="fixed md:relative w-64 h-full glass border-r border-gray-800 flex flex-col z-30 shadow-2xl sidebar-transition -translate-x-full md:translate-x-0 bg-gray-900">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <h2 class="text-lg font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">ADMIN PANEL</h2>
                <button onclick="closeSidebar()" class="md:hidden text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div class="px-6 py-4 border-b border-gray-800/50 bg-gray-800/20">
                 <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-cyan-500 to-blue-600 flex items-center justify-center font-bold text-white shadow-lg shrink-0">üëë</div>
                    <div class="overflow-hidden">
                        <div id="current-admin-name" class="font-bold text-sm text-white truncate">...</div>
                        <div id="current-admin-role" class="text-[10px] text-gray-400 uppercase tracking-wide truncate">...</div>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition active-tab">üìä <span class="text-sm font-medium">Dashboard</span></button>
                <button id="nav-users" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition">üë§ <span class="text-sm font-medium">T·∫°o User M·ªõi</span></button>
                <button id="nav-admin" class="w-full hidden flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition">üëë <span class="text-sm font-medium">T·∫°o Admin Con</span></button>
                <button id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition">‚öôÔ∏è <span class="text-sm font-medium">C√†i ƒê·∫∑t</span></button>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <button id="logout-btn" class="w-full flex items-center justify-center gap-2 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white px-4 py-3 rounded-xl transition text-sm font-bold">ƒêƒÉng Xu·∫•t</button>
            </div>
        </aside>

        <main class="flex-1 relative flex flex-col overflow-hidden bg-gradient-to-br from-[#0f172a] to-[#020617] w-full">
            <header class="h-16 border-b border-gray-800 flex items-center justify-between px-4 md:px-8 bg-gray-900/50 backdrop-blur-sm sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <button id="mobile-menu-btn" class="md:hidden text-gray-400 hover:text-white p-1">‚ò∞</button>
                    <div class="text-xs text-gray-500 font-mono hidden md:block">System v2.6 Mobile</div>
                </div>
                <div class="flex items-center gap-2">
                    <!-- BADGE SUPER ADMIN -->
                    <div id="super-admin-badge" class="hidden px-3 py-1 bg-red-600 text-white text-[10px] font-bold rounded-full animate-pulse shadow-lg border border-red-400">
                        SUPER ADMIN MODE
                    </div>
                    <div class="flex items-center gap-2 px-3 py-1 bg-green-500/10 rounded-full border border-green-500/20">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                        <span class="text-[10px] font-bold text-green-400 tracking-wider">ONLINE</span>
                    </div>
                </div>
            </header>

            <div class="p-4 md:p-8 flex-1 overflow-y-auto custom-scrollbar w-full">
                <!-- VIEW: DASHBOARD -->
                <div id="view-dashboard" class="space-y-6 fade-in pb-20">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 pb-4 border-b border-gray-800">
                        <div>
                            <h3 class="text-xl md:text-2xl font-bold text-white mb-1">Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</h3>
                            <p class="text-gray-400 text-xs md:text-sm">Danh s√°ch hi·ªÉn th·ªã: <span id="total-users-count" class="text-cyan-400 font-bold">0</span></p>
                        </div>
                        <div class="flex flex-wrap gap-2 w-full md:w-auto">
                            <input id="search-input" type="text" placeholder="T√¨m username..." class="bg-gray-800 border border-gray-700 text-sm rounded-lg px-4 py-2.5 flex-1 md:w-64 outline-none focus:border-cyan-500 transition">
                            <button id="search-btn" class="bg-cyan-600 hover:bg-cyan-500 px-5 py-2.5 rounded-lg text-white text-sm font-bold shadow-lg transition">T√¨m</button>
                            <button id="refresh-btn" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 px-4 py-2.5 rounded-lg text-white text-sm transition">‚Üª</button>
                        </div>
                    </div>
                    <div class="bg-gray-900/40 rounded-xl border border-gray-800 shadow-xl backdrop-blur-sm table-container">
                        <table class="w-full text-left min-w-[800px] md:min-w-0">
                            <thead class="bg-gray-800/80 text-gray-400 text-xs uppercase font-semibold tracking-wider sticky top-0">
                                <tr>
                                    <th class="px-4 py-4 w-20">ID</th>
                                    <th class="px-4 py-4">Account</th>
                                    <th class="px-4 py-4">Contact</th>
                                    <th class="px-4 py-4 text-center">Energy</th>
                                    <th class="px-4 py-4 w-32">Rank</th>
                                    <th class="px-4 py-4">Action</th>
                                    <!-- C·ªòT X√ìA CH·ªà HI·ªÜN KHI L√Ä SUPER ADMIN -->
                                    <th id="th-delete-action" class="px-4 py-4 text-center text-red-500 hidden w-24">SUPER ADMIN</th> 
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="divide-y divide-gray-800 text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: CREATE USER -->
                <div id="view-users" class="hidden max-w-2xl mx-auto mt-4 md:mt-10 fade-in pb-20">
                    <div class="glass p-6 md:p-8 rounded-2xl shadow-2xl border-t-4 border-cyan-500">
                        <h3 class="text-xl font-bold mb-6 md:mb-8 text-white flex items-center gap-3">
                            <span class="w-8 h-8 rounded-lg bg-cyan-500/20 flex items-center justify-center text-cyan-400">üë§</span> T·∫°o Kh√°ch Thu√™ M·ªõi
                        </h3>
                        <form id="create-user-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Username</label><input id="new-username" type="text" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg p-3 focus:border-cyan-500 outline-none transition" required></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Password</label><input id="new-password" type="text" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg p-3 focus:border-cyan-500 outline-none transition" required></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Telegram</label><input id="new-tele" type="text" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg p-3 focus:border-cyan-500 outline-none transition" placeholder="@username"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Phone</label><input id="new-phone" type="text" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg p-3 focus:border-cyan-500 outline-none transition"></div>
                            </div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Energy Ban ƒê·∫ßu</label><input id="new-energy" type="number" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg p-3 focus:border-cyan-500 outline-none transition" value="0"></div>
                            <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3.5 rounded-lg shadow-lg transition mt-2">X√ÅC NH·∫¨N T·∫†O USER</button>
                        </form>
                    </div>
                </div>

                <!-- VIEW: CREATE ADMIN -->
                <div id="view-admin" class="hidden max-w-2xl mx-auto mt-4 md:mt-10 fade-in pb-20">
                    <div class="glass p-6 md:p-8 rounded-2xl shadow-2xl border-t-4 border-yellow-500">
                        <h3 class="text-xl font-bold text-yellow-400 flex items-center gap-3 mb-8">
                            <span class="w-8 h-8 rounded-lg bg-yellow-500/20 flex items-center justify-center">üëë</span> T·∫°o Admin Con
                        </h3>
                        <form id="create-admin-form" class="space-y-6">
                            <div><label class="block text-xs font-bold text-yellow-600 mb-2 uppercase">Admin Username</label><input id="new-admin-user" type="text" class="w-full bg-black/40 border border-yellow-800/50 rounded-lg p-3 text-yellow-100 focus:border-yellow-500 outline-none transition" required></div>
                            <div><label class="block text-xs font-bold text-yellow-600 mb-2 uppercase">Password</label><input id="new-admin-pass" type="text" class="w-full bg-black/40 border border-yellow-800/50 rounded-lg p-3 text-yellow-100 focus:border-yellow-500 outline-none transition" required></div>
                            <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-3.5 rounded-lg shadow-lg mt-2">C·∫§P QUY·ªÄN ADMIN</button>
                        </form>
                    </div>
                </div>

                <!-- VIEW: SETTINGS -->
                <div id="view-settings" class="hidden max-w-2xl mx-auto mt-4 md:mt-10 fade-in pb-20">
                    <div class="glass p-6 md:p-8 rounded-2xl shadow-2xl border-t-4 border-purple-500">
                        <h3 class="text-xl font-bold mb-6 md:mb-8 text-white flex items-center gap-3">
                            <span class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400">üîí</span> ƒê·ªïi M·∫≠t Kh·∫©u
                        </h3>
                        <form id="change-pass-form" class="space-y-6">
                            <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">M·∫≠t kh·∫©u m·ªõi</label><input id="new-pass" type="password" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg p-3 focus:border-purple-500 outline-none transition" required minlength="6"></div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">X√°c nh·∫≠n m·∫≠t kh·∫©u</label><input id="confirm-pass" type="password" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg p-3 focus:border-purple-500 outline-none transition" required minlength="6"></div>
                            <button type="submit" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3.5 rounded-lg shadow-lg mt-2">C·∫¨P NH·∫¨T M·∫¨T KH·∫®U</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
